<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ØªØ±Ø¬Ù…Ù‡ ÙØ§Ø±Ø³ÛŒ Ù‚Ø±Ø¢Ù† â€” Ù…ØªÙ† Ùˆ ØµÙˆØª</title>
  <style>
    body{font-family: Vazirmatn, "Tahoma", sans-serif; background:#f6fbf7; color:#1b1b1b; margin:0; padding:18px; direction:rtl}
    header{background:#0b7a54; color:#fff; padding:14px 18px; border-radius:10px}
    h1{margin:0; font-size:20px}
    .controls{margin:14px 0; display:flex; gap:10px; flex-wrap:wrap}
    select, button {font-size:16px; padding:10px; border-radius:8px; border:1px solid #cfd8ce}
    button{background:#0b7a54;color:#fff;cursor:pointer}
    .card{background:#fff;border-radius:12px;padding:14px;box-shadow:0 6px 20px rgba(16,24,32,0.06); max-width:980px; margin-top:14px}
    #translation{white-space:pre-wrap; text-align:justify; line-height:1.9}
    #status{margin-top:8px;color:#555}
    .tts-controls{margin-top:10px; display:flex; gap:8px; flex-wrap:wrap}
    audio{width:100%; margin-top:10px}
    footer{margin-top:18px; color:#666; font-size:13px}
    @media (max-width:600px){ header{padding:10px} select,button{font-size:15px} }
  </style>
</head>
<body>
  <header>
    <h1>ğŸ“– ØªØ±Ø¬Ù…Ù‡ ÙØ§Ø±Ø³ÛŒ Ù‚Ø±Ø¢Ù† â€” Ù…ØªÙ† Ùˆ Ù¾Ø®Ø´ ØµÙˆØªÛŒ</h1>
  </header>

  <div class="card">
    <div class="controls">
      <label for="surahSelect">Ø§Ù†ØªØ®Ø§Ø¨ Ø³ÙˆØ±Ù‡:</label>
      <select id="surahSelect" aria-label="Ø§Ù†ØªØ®Ø§Ø¨ Ø³ÙˆØ±Ù‡"></select>
      <button id="showBtn">Ù†Ù…Ø§ÛŒØ´ ØªØ±Ø¬Ù…Ù‡</button>
      <button id="playAudioBtn">Ù¾Ø®Ø´ ØµÙˆØª (Ø³Ø¹ÛŒ Ø¨Ø±Ø§ÛŒ ÙØ§ÛŒÙ„ Ø®Ø§Ø±Ø¬ÛŒ)</button>
      <button id="speakBtn">Ù¾Ø®Ø´ Ø¨Ø§ ØµØ¯Ø§Ø³Ø§Ø²ÛŒ Ù…Ø±ÙˆØ±Ú¯Ø± (TTS)</button>
      <button id="stopTTSBtn">ØªÙˆÙ‚Ù TTS</button>
    </div>

    <div id="status">ÙˆØ¶Ø¹ÛŒØª: Ø¢Ù…Ø§Ø¯Ù‡</div>

    <div id="result" class="card">
      <h3 id="surahTitle">ØªØ±Ø¬Ù…Ù‡ Ø³ÙˆØ±Ù‡ â€” Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†</h3>
      <div id="translation">ÙØ¹Ù„Ø§ Ù…ØªÙ†ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø´Ø¯Ù‡.</div>
      <audio id="audioPlayer" controls crossorigin="anonymous" style="display:none"></audio>

      <div class="tts-controls" id="ttsControls" style="display:none">
        <small>Ú©Ù†ØªØ±Ù„ TTS: Ø¯Ø± ØµÙˆØ±ØªÛŒ Ú©Ù‡ ØµØ¯Ø§ÛŒ ÙØ§Ø±Ø³ÛŒ Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ø´Ø¯ Ø¨Ù‡ØªØ± Ø§Ø³Øª.</small>
      </div>
    </div>

    <footer>
      ØªØ±Ø¬Ù…Ù‡ Ù…ØªÙ†ÛŒ Ø§Ø² API Ø¢Ù†Ù„Ø§ÛŒÙ† (Ansanrian) â€” ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ØµÙˆØªÛŒ Ø§ÛŒØ±Ø§Ù†ÛŒ (Ù…Ø«Ù„Ø§Ù‹ MasoudRiaei). Ø¯Ø± ØµÙˆØ±Øª Ø¹Ø¯Ù… Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ ÙØ§ÛŒÙ„ØŒ Ø§Ø² ØµØ¯Ø§Ø³Ø§Ø²ÛŒ Ù…Ø±ÙˆØ±Ú¯Ø± (TTS) Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
      <br>Ø§Ú¯Ø± Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ mp3 Ù…Ø®ØµÙˆØµ ÛŒÚ© Ù…Ù†Ø¨Ø¹ Ø±Ø§ Ø¯Ø§Ø®Ù„ Ù¾Ø±ÙˆÚ˜Ù‡ Ù‚Ø±Ø§Ø± Ø¯Ù‡Ù… (ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…Ø­Ù„ÛŒ ÛŒØ§ Ù„ÛŒÙ†Ú© Ù…Ø³ØªÙ‚ÛŒÙ…)ØŒ Ø¨Ú¯Ùˆ ØªØ§ Ù„ÛŒØ³Øª Ú©Ø§Ù…Ù„ Ø±Ø§ Ø¨Ø³Ø§Ø²Ù….
    </footer>
  </div>

<script>
/* ===== Ù„ÛŒØ³Øª Ú©Ø§Ù…Ù„ Ø³ÙˆØ±Ù‡â€ŒÙ‡Ø§ (Û± ØªØ§ Û±Û±Û´) ===== */
const surahNames = [
"Ø§Ù„ÙØ§ØªØ­Ù‡","Ø§Ù„Ø¨Ù‚Ø±Ù‡","Ø¢Ù„â€ŒØ¹Ù…Ø±Ø§Ù†","Ø§Ù„Ù†Ø³Ø§Ø¡","Ø§Ù„Ù…Ø§Ø¦Ø¯Ù‡","Ø§Ù„Ø§Ù†Ø¹Ø§Ù…","Ø§Ù„Ø§Ø¹Ø±Ø§Ù","Ø§Ù„Ø§Ù†ÙØ§Ù„","Ø§Ù„ØªÙˆØ¨Ù‡","ÛŒÙˆÙ†Ø³",
"Ù‡ÙˆØ¯","ÛŒÙˆØ³Ù","Ø§Ù„Ø±Ø¹Ø¯","Ø§Ø¨Ø±Ø§Ù‡ÛŒÙ…","Ø§Ù„Ø­Ø¬Ø±","Ø§Ù„Ù†Ø­Ù„","Ø§Ù„Ø§Ø³Ø±Ø§Ø¡","Ø§Ù„Ú©Ù‡Ù","Ù…Ø±ÛŒÙ…","Ø·Ù‡","Ø§Ù„Ø§Ù†Ø¨ÛŒØ§Ø¡","Ø§Ù„Ø­Ø¬",
"Ø§Ù„Ù…Ø¤Ù…Ù†ÙˆÙ†","Ø§Ù„Ù†ÙˆØ±","Ø§Ù„ÙØ±Ù‚Ø§Ù†","Ø§Ù„Ø´Ø¹Ø±Ø§Ø¡","Ø§Ù„Ù†Ù…Ù„","Ø§Ù„Ù‚ØµØµ","Ø§Ù„Ø¹Ù†Ú©Ø¨ÙˆØª","Ø§Ù„Ø±ÙˆÙ…","Ù„Ù‚Ù…Ø§Ù†","Ø§Ù„Ø³Ø¬Ø¯Ù‡","Ø§Ù„Ø§Ø­Ø²Ø§Ø¨",
"Ø³Ø¨Ø£","ÙØ§Ø·Ø±","ÛŒØ³","Ø§Ù„ØµØ§ÙØ§Øª","Øµ","Ø§Ù„Ø²Ù…Ø±","ØºØ§ÙØ±","ÙØµÙ„Øª","Ø§Ù„Ø´ÙˆØ±ÛŒ","Ø§Ù„Ø²Ø®Ø±Ù","Ø§Ù„Ø¯Ø®Ø§Ù†","Ø§Ù„Ø¬Ø§Ø«ÛŒÙ‡","Ø§Ù„Ø§Ø­Ù‚Ø§Ù",
"Ù…Ø­Ù…Ø¯","Ø§Ù„ÙØªØ­","Ø§Ù„Ø­Ø¬Ø±Ø§Øª","Ù‚","Ø§Ù„Ø°Ø§Ø±ÛŒØ§Øª","Ø§Ù„Ø·ÙˆØ±","Ø§Ù„Ù†Ø¬Ù…","Ø§Ù„Ù‚Ù…Ø±","Ø§Ù„Ø±Ø­Ù…Ù†","Ø§Ù„ÙˆØ§Ù‚Ø¹Ù‡","Ø§Ù„Ø­Ø¯ÛŒØ¯","Ø§Ù„Ù…Ø¬Ø§Ø¯Ù„Ù‡",
"Ø§Ù„Ø­Ø´Ø±","Ø§Ù„Ù…Ù…ØªØ­Ù†Ù‡","Ø§Ù„ØµÙ","Ø§Ù„Ø¬Ù…Ø¹Ø©","Ø§Ù„Ù…Ù†Ø§ÙÙ‚ÙˆÙ†","Ø§Ù„ØªØºØ§Ø¨Ù†","Ø§Ù„Ø·Ù„Ø§Ù‚","Ø§Ù„ØªØ­Ø±ÛŒÙ…","Ø§Ù„Ù…Ù„Ú©","Ø§Ù„Ù‚Ù„Ù…","Ø§Ù„Ø­Ø§Ù‚Ù‡",
"Ø§Ù„Ù…Ø¹Ø§Ø±Ø¬","Ù†ÙˆØ­","Ø§Ù„Ø¬Ù†","Ø§Ù„Ù…Ø²Ù…Ù„","Ø§Ù„Ù…Ø¯Ø«Ø±","Ø§Ù„Ù‚ÛŒØ§Ù…Ù‡","Ø§Ù„Ø§Ù†Ø³Ø§Ù†","Ø§Ù„Ù…Ø±Ø³Ù„Ø§Øª","Ø§Ù„Ù†Ø¨Ø£","Ø§Ù„Ù†Ø§Ø²Ø¹Ø§Øª","Ø¹Ø¨Ø³","Ø§Ù„ØªÚ©ÙˆÛŒØ±",
"Ø§Ù„Ø§Ù†ÙØ·Ø§Ø±","Ø§Ù„Ù…Ø·ÙÙÛŒÙ†","Ø§Ù„Ø§Ù†Ø´Ù‚Ø§Ù‚","Ø§Ù„Ø¨Ø±ÙˆØ¬","Ø§Ù„Ø·Ø§Ø±Ù‚","Ø§Ù„Ø§Ø¹Ù„ÛŒ","Ø§Ù„ØºØ§Ø´ÛŒÙ‡","Ø§Ù„ÙØ¬Ø±","Ø§Ù„Ø¨Ù„Ø¯","Ø§Ù„Ø´Ù…Ø³","Ø§Ù„Ù„ÛŒÙ„",
"Ø§Ù„Ø¶Ø­ÛŒ","Ø§Ù„Ø´Ø±Ø­","Ø§Ù„ØªÛŒÙ†","Ø§Ù„Ø¹Ù„Ù‚","Ø§Ù„Ù‚Ø¯Ø±","Ø§Ù„Ø¨ÛŒÙ†Ù‡","Ø§Ù„Ø²Ù„Ø²Ù„Ù‡","Ø§Ù„Ø¹Ø§Ø¯ÛŒØ§Øª","Ø§Ù„Ù‚Ø§Ø±Ø¹Ù‡","Ø§Ù„ØªÚ©Ø§Ø«Ø±","Ø§Ù„Ø¹ØµØ±","Ø§Ù„Ù‡Ù…Ø²Ù‡",
"Ø§Ù„ÙÛŒÙ„","Ù‚Ø±ÛŒØ´","Ø§Ù„Ù…Ø§Ø¹ÙˆÙ†","Ø§Ù„Ú©ÙˆØ«Ø±","Ø§Ù„Ú©Ø§ÙØ±ÙˆÙ†","Ø§Ù„Ù†ØµØ±","Ø§Ù„Ù…Ø³Ø¯","Ø§Ù„Ø§Ø®Ù„Ø§Øµ","Ø§Ù„ÙÙ„Ù‚","Ø§Ù„Ù†Ø§Ø³"
];

/* Ø§Ù„Ù…Ø§Ù†â€ŒÙ‡Ø§ */
const surahSelect = document.getElementById('surahSelect');
const showBtn = document.getElementById('showBtn');
const playAudioBtn = document.getElementById('playAudioBtn');
const speakBtn = document.getElementById('speakBtn');
const stopTTSBtn = document.getElementById('stopTTSBtn');
const status = document.getElementById('status');
const surahTitle = document.getElementById('surahTitle');
const translationDiv = document.getElementById('translation');
const audioPlayer = document.getElementById('audioPlayer');
const ttsControls = document.getElementById('ttsControls');

/* Ù¾Ø± Ú©Ø±Ø¯Ù† Ù…Ù†ÙˆÛŒ Ø§Ù†ØªØ®Ø§Ø¨ */
surahNames.forEach((name, idx) => {
  const o = document.createElement('option');
  o.value = idx + 1;
  o.textContent = `${idx+1}. ${name}`;
  surahSelect.appendChild(o);
});

/* ÙˆØ¶Ø¹ÛŒØª Ùˆ Ù…ØªÙ† ØªØ±Ø¬Ù…Ù‡ ÙØ¹Ù„ÛŒ */
let currentTranslationText = '';
let currentSurahNumber = 1;

/* ØªØ§Ø¨Ø¹ Ú¯Ø±ÙØªÙ† ØªØ±Ø¬Ù…Ù‡ Ø§Ø² API (fa.ansarian) */
async function fetchTranslation(surahNumber) {
  status.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª ØªØ±Ø¬Ù…Ù‡ Ø§Ø² Ø³Ø±ÙˆØ±...';
  translationDiv.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª ØªØ±Ø¬Ù…Ù‡...';
  try {
    const res = await fetch(`https://api.alquran.cloud/v1/surah/${surahNumber}/fa.ansarian`);
    const j = await res.json();
    if (!j || !j.data || !j.data.ayahs) throw new Error('Ù¾Ø§Ø³Ø® Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø² API');
    // Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ù…ØªÙ† ØªØ±Ø¬Ù…Ù‡
    const ayahs = j.data.ayahs.map(a => `${a.numberInSurah}. ${a.text}`);
    currentTranslationText = ayahs.join('\n\n');
    const title = `${j.data.number}. ${j.data.englishName} â€” ${j.data.name}`;
    surahTitle.textContent = title;
    translationDiv.innerHTML = currentTranslationText.replace(/\n\n/g, '<br><br>');
    status.textContent = 'ØªØ±Ø¬Ù…Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯.';
  } catch (err) {
    console.error(err);
    translationDiv.textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ØªØ±Ø¬Ù…Ù‡. Ø¨Ø±Ø±Ø³ÛŒ Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª ÛŒØ§ Ø¨Ø¹Ø¯Ø§ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.';
    status.textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ú¯Ø±ÙØªÙ† ØªØ±Ø¬Ù…Ù‡.';
    currentTranslationText = '';
  }
}

/* Ø¯Ú©Ù…Ù‡ Ù†Ù…Ø§ÛŒØ´ ØªØ±Ø¬Ù…Ù‡ */
showBtn.addEventListener('click', () => {
  const n = Number(surahSelect.value) || 1;
  currentSurahNumber = n;
  // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØ±Ø¬Ù…Ù‡
  fetchTranslation(n);
  // Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ù¾Ù„ÛŒØ± Ø®Ø§Ù… (ØªØ§ ÙˆÙ‚ØªÛŒ Ú©Ø§Ø±Ø¨Ø± ØµØ±ÛŒØ­Ø§ Ù¾Ø®Ø´ Ù†Ú©Ù†Ø¯)
  audioPlayer.style.display = 'none';
  audioPlayer.src = '';
});

/* ===== ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ§ÛŒÙ„ ØµÙˆØªÛŒ Ø®Ø§Ø±Ø¬ÛŒ (Ù„ÛŒØ³Øª Ø§Ù„Ú¯ÙˆÙ‡Ø§ÛŒ Ø§Ø­ØªÙ…Ø§Ù„ÛŒ) =====
  Ø±ÙˆØ´: ÛŒÚ© Ø¢Ø±Ø§ÛŒÙ‡ Ø§Ø² Ø§Ù„Ú¯ÙˆÙ‡Ø§ Ù…ÛŒâ€ŒØ³Ø§Ø²ÛŒÙ… Ùˆ Ø¨Ù‡â€Œ ØªØ±ØªÛŒØ¨ Ø§Ù…ØªØ­Ø§Ù† Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ….
  Ø§Ú¯Ø± Ù‡ÛŒÚ†Ú©Ø¯Ø§Ù… Ù‚Ø§Ø¨Ù„ Ù¾Ø®Ø´ Ù†Ø¨ÙˆØ¯Ù†Ø¯ØŒ Ø¨Ù‡ TTS Ù…ÛŒâ€ŒØ±ÙˆÛŒÙ….
*/
function makeCandidates(n) {
  const p2 = String(n).padStart(2,'0'); // 01 .. 99
  const p3 = String(n).padStart(3,'0'); // 001 .. 114
  // Ø§Ù„Ú¯ÙˆÙ‡Ø§ÛŒ Ù…Ø­ØªÙ…Ù„ (Ø¨Ø±Ø®ÛŒ Ø§Ø­ØªÙ…Ø§Ù„ÛŒ â€” Ø§Ú¯Ø± Ø³Ø±ÙˆØ± Ù…Ø³ÛŒØ± Ø¯Ù‚ÛŒÙ‚ Ù…ØªÙØ§ÙˆØª Ø¨Ø§Ø´Ø¯ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ú©Ø§Ø± Ù†Ú©Ù†Ø¯)
  return [
    `https://dl.masoudriaei.com/quran-translation-fa/${p2}.mp3`,
    `https://dl.masoudriaei.com/quran-translation-fa/${p3}.mp3`,
    `https://dl.masoudriaei.com/quran_translation/farsi/${p3}.mp3`,
    `https://dl.masoudriaei.com/quran_translation/farsi/${p2}.mp3`,
    // Ø¨Ø¹Ø¶ÛŒ Ø³Ø§ÛŒØªâ€ŒÙ‡Ø§ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø±Ø§ ØªØ­Øª Ù…Ø³ÛŒØ±Ù‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø± ÛŒØ§ Ø±ÙˆÛŒ CDN Ù…ÛŒâ€ŒÚ¯Ø°Ø§Ø±Ù†Ø¯ â€” Ø§ÛŒÙ†â€ŒÙ‡Ø§ Ø¨Ø±Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø­ØªÙ…Ù„â€ŒØ§Ù†Ø¯:
    `https://cdn.masoudriaei.com/quran-translation/${p3}.mp3`,
    `https://dl.masoudriaei.com/quran-translation/${p3}.mp3`
  ];
}

/* ØªÙ„Ø§Ø´ ØªØ±ØªÛŒØ¨ÛŒ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ */
let tryingIndex = -1;
function tryNextCandidate(n, candidates) {
  tryingIndex++;
  if (tryingIndex >= candidates.length) {
    // Ù‡Ù…Ù‡ Ø§Ù„Ú¯ÙˆÙ‡Ø§ Ø§Ù…ØªØ­Ø§Ù† Ø´Ø¯Ù†Ø¯ Ùˆ Ù…ÙˆÙÙ‚ Ù†Ø´Ø¯ -> Ø¨Ù‡ TTS Ù…ÛŒâ€ŒØ±ÙˆÛŒÙ…
    status.textContent = 'ÙØ§ÛŒÙ„ ØµÙˆØªÛŒ Ø®Ø§Ø±Ø¬ÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ ÛŒØ§ Ù‚Ø§Ø¨Ù„ Ù¾Ø®Ø´ Ù†ÛŒØ³Øª â€” Ø§Ø² ØµØ¯Ø§Ø³Ø§Ø²ÛŒ Ù…Ø±ÙˆØ±Ú¯Ø± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.';
    audioPlayer.style.display = 'none';
    showTTSControls(true);
    return;
  }
  const url = candidates[tryingIndex];
  status.textContent = `Ø¯Ø± Ø­Ø§Ù„ ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ§ÛŒÙ„ ØµÙˆØªÛŒ (Ø§Ù„Ú¯Ùˆ ${tryingIndex+1}/${candidates.length})...`;
  // ØªÙ†Ø¸ÛŒÙ… Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù…Ù†Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø¹Ù†ØµØ± audio Ùˆ Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù† Ø¨Ù‡ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ canplay Ùˆ error
  audioPlayer.src = url;
  audioPlayer.style.display = 'block';
  audioPlayer.load();

  // Timeout Ø¯Ø± ØµÙˆØ±ØªÛŒÚ©Ù‡ canplay ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ù†Ø´ÙˆØ¯ (Ù…Ø«Ù„Ø§Ù‹ Ø³Ø±ÙˆØ± Ù¾Ø§Ø³Ø® Ù†Ù…ÛŒâ€ŒØ¯Ù‡Ø¯)
  let timedOut = false;
  const timeoutId = setTimeout(() => {
    timedOut = true;
    // Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ src Ùˆ Ø±ÙØªÙ† Ø¨Ù‡ Ú¯Ø²ÛŒÙ†Ù‡ Ø¨Ø¹Ø¯ÛŒ
    audioPlayer.pause();
    audioPlayer.src = '';
    tryNextCandidate(n, candidates);
  }, 8000); // 8 Ø«Ø§Ù†ÛŒÙ‡ Ø¨Ø±Ø§ÛŒ ØªÙ„Ø§Ø´ Ù‡Ø± Ù„ÛŒÙ†Ú©

  function cleanupAndPlay() {
    clearTimeout(timeoutId);
    audioPlayer.removeEventListener('canplay', onCanPlay);
    audioPlayer.removeEventListener('error', onError);
    // Ø§Ú¯Ø± canplay Ø±Ø® Ø¯Ù‡Ø¯ØŒ ÛŒØ¹Ù†ÛŒ ÙØ§ÛŒÙ„ Ù‚Ø§Ø¨Ù„ Ù¾Ø®Ø´ Ø§Ø³Øª
    status.textContent = `ÙØ§ÛŒÙ„ ØµÙˆØªÛŒ Ù¾ÛŒØ¯Ø§ Ø´Ø¯: ${url}`;
    showTTSControls(false);
    // Ø§Ø¬Ø§Ø²Ù‡ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø±Ø§ÛŒ Ù¾Ø®Ø´/Ù…Ú©Ø« (Ø®ÙˆØ¯Ú©Ø§Ø± Ù¾Ø®Ø´ Ø±Ø§ ØªÙ†Ù‡Ø§ Ø¨Ø§ Ú©Ù„ÛŒÚ© Ú©Ø§Ø±Ø¨Ø± Ø§Ù†Ø¬Ø§Ù… Ø¨Ø¯Ù‡ÛŒÙ…)
    // ÙÙ‚Ø· Ø§Ú¯Ø± Ù‚Ø¨Ù„Ø§Ù‹ Ú©Ø§Ø±Ø¨Ø± Ú©Ù„ÛŒÚ© Ú©Ø±Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ù¾Ø®Ø´ØŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒÙ… autoplay Ú©Ù†ÛŒÙ…:
    // Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù‡ Ø¬Ø§ÛŒ autoplay Ø®ÙˆØ¯Ú©Ø§Ø±ØŒ ØµØ±ÙØ§ Ù…Ù†Ø¨Ø¹ Ù‚Ø±Ø§Ø± Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯ Ùˆ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ú©Ù†ØªØ±Ù„ audio Ù¾Ø®Ø´ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
  }
  function onCanPlay() {
    if (timedOut) return;
    cleanupAndPlay();
  }
  function onError() {
    if (timedOut) return;
    clearTimeout(timeoutId);
    audioPlayer.removeEventListener('canplay', onCanPlay);
    audioPlayer.removeEventListener('error', onError);
    // Ù„ÛŒÙ†Ú© Ù†Ø§Ù…Ø¹ØªØ¨Ø± ÛŒØ§ Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ø³Ø¯ÙˆØ¯ â†’ Ú¯Ø²ÛŒÙ†Ù‡ Ø¨Ø¹Ø¯ÛŒ
    audioPlayer.pause();
    audioPlayer.src = '';
    tryNextCandidate(n, candidates);
  }

  audioPlayer.addEventListener('canplay', onCanPlay);
  audioPlayer.addEventListener('error', onError);
}

/* Ø¯Ú©Ù…Ù‡ "Ù¾Ø®Ø´ ØµÙˆØª (ÙØ§ÛŒÙ„ Ø®Ø§Ø±Ø¬ÛŒ)" */
playAudioBtn.addEventListener('click', () => {
  // Ø§Ú¯Ø± ØªØ±Ø¬Ù…Ù‡ Ù…ØªÙ† Ù‡Ù†ÙˆØ² Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ØŒ Ø§ÙˆÙ„ Ù…ØªÙ† Ø±Ø§ Ø¨Ú¯ÛŒØ±
  const n = Number(surahSelect.value) || currentSurahNumber || 1;
  currentSurahNumber = n;
  if (!currentTranslationText) {
    fetchTranslation(n).then(() => {
      startAudioTrials(n);
    }).catch(() => startAudioTrials(n));
  } else {
    startAudioTrials(n);
  }
});

function startAudioTrials(n){
  // Ø´Ø±ÙˆØ¹ ØªÙ„Ø§Ø´â€ŒÙ‡Ø§
  tryingIndex = -1;
  const candidates = makeCandidates(n);
  status.textContent = 'Ø¢ØºØ§Ø² Ø¬Ø³ØªØ¬ÙˆÛŒ ÙØ§ÛŒÙ„ ØµÙˆØªÛŒ Ø®Ø§Ø±Ø¬ÛŒ... (Ù…Ù…Ú©Ù† Ø§Ø³Øª Ú†Ù†Ø¯ Ø«Ø§Ù†ÛŒÙ‡ Ø·ÙˆÙ„ Ø¨Ú©Ø´Ø¯)';
  showTTSControls(false);
  tryNextCandidate(n, candidates);
}

/* ===== TTS (Ù¾Ø®Ø´ Ø¨Ø§ ØµØ¯Ø§Ø³Ø§Ø²ÛŒ Ù…Ø±ÙˆØ±Ú¯Ø±) ===== */
let utterance = null;
function speakCurrentText(){
  if (!currentTranslationText) {
    status.textContent = 'Ø§Ø¨ØªØ¯Ø§ ØªØ±Ø¬Ù…Ù‡ Ø±Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯ (Ø¯Ú©Ù…Ù‡ Ù†Ù…Ø§ÛŒØ´ ØªØ±Ø¬Ù…Ù‡)';
    return;
  }
  if (!('speechSynthesis' in window)) {
    status.textContent = 'Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² Web Speech API Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯.';
    return;
  }
  // Ø§Ú¯Ø± Ø¯Ø± Ø­Ø§Ù„ ØµØ­Ø¨Øª Ø¨ÙˆØ¯ÛŒÙ…ØŒ Ø§Ø¨ØªØ¯Ø§ Ù…ØªÙˆÙ‚Ù Ú©Ù†ÛŒÙ…
  speechSynthesis.cancel();

  utterance = new SpeechSynthesisUtterance(currentTranslationText);
  // ØªÙ†Ø¸ÛŒÙ… Ø²Ø¨Ø§Ù† Ø¨Ù‡ ÙØ§Ø±Ø³ÛŒ (Ø¯Ø± Ø¨Ø±Ø®ÛŒ Ù…Ø±ÙˆØ±Ú¯Ø±Ù‡Ø§ fa-IR Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯)
  utterance.lang = 'fa-IR';
  // Ø³Ø±Ø¹Øª/Ù„Ø­Ù† Ù‚Ø§Ø¨Ù„ ØªØºÛŒÛŒØ±:
  utterance.rate = 1.0;
  utterance.pitch = 1.0;

  utterance.onstart = () => { status.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø®Ø´ (TTS)...'; };
  utterance.onend = () => { status.textContent = 'Ù¾Ø§ÛŒØ§Ù† Ù¾Ø®Ø´ TTS.'; };
  utterance.onerror = (e) => { console.error(e); status.textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø®Ø´ TTS.'; };

  // Ø´Ø±ÙˆØ¹
  try {
    speechSynthesis.speak(utterance);
    showTTSControls(true);
  } catch (err) {
    console.error(err);
    status.textContent = 'Ù¾Ø®Ø´ TTS Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯.';
  }
}

/* ØªÙˆÙ‚Ù/Ù…Ú©Ø«/Ø§Ø¯Ø§Ù…Ù‡ TTS */
stopTTSBtn.addEventListener('click', () => {
  if ('speechSynthesis' in window) {
    speechSynthesis.cancel();
    status.textContent = 'Ù¾Ø®Ø´ TTS Ù…ØªÙˆÙ‚Ù Ø´Ø¯.';
  }
});
speakBtn.addEventListener('click', () => {
  speakCurrentText();
});

/* Ù†Ù…Ø§ÛŒØ´ ÛŒØ§ Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ÛŒ TTS */
function showTTSControls(show){
  ttsControls.style.display = show ? 'block' : 'none';
}

/* ÙˆÙ‚ØªÛŒ ØµÙØ­Ù‡ Ø¨Ø§Ø±Ú¯Ø²Ø§Ø±ÛŒ Ø´Ø¯: Ù…Ù‚Ø¯Ø§Ø± Ø§ÙˆÙ„ÛŒÙ‡ */
window.addEventListener('load', () => {
  // Ù…Ù‚Ø¯Ø§Ø± Ø§ÙˆÙ„ÛŒÙ‡ Ø³ÙˆØ±Ù‡ Ø§ÙˆÙ„ Ø±Ø§ Ø¢Ù…Ø§Ø¯Ù‡ Ú©Ù†
  currentSurahNumber = 1;
  fetchTranslation(1).catch(()=>{});
  showTTSControls(false);
  audioPlayer.style.display = 'none';
  status.textContent = 'Ø¢Ù…Ø§Ø¯Ù‡. ÛŒÚ© Ø³ÙˆØ±Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ Ùˆ Ø±ÙˆÛŒ "Ù†Ù…Ø§ÛŒØ´ ØªØ±Ø¬Ù…Ù‡" Ø¨Ø²Ù†ÛŒØ¯.';
});
</script>
</body>
</html>